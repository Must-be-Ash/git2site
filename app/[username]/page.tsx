import { notFound } from 'next/navigation';
import { connectDB } from '@/lib/db';
import { User } from '@/lib/models/user';
import { Repository } from '@/lib/models/repository';
import { PortfolioHeader } from '@/components/portfolio/header';
import { RepositoryGrid } from '@/components/portfolio/repository-grid';
import { ThemeProvider } from '@/components/providers/theme-provider';

export async function generateMetadata({ params }: { params: { username: string } }) {
  return {
    title: `${params.username}'s Portfolio | Git2Site`,
    description: `View ${params.username}'s GitHub portfolio generated by Git2Site`,
  };
}

type Props = {
  params: { username: string };
  searchParams: { [key: string]: string | string[] | undefined };
};

export default async function PortfolioPage(props: Props) {
  const { username } = props.params;
  
  try {
    await connectDB();
    
    console.log(`Fetching user data for username: ${username}`);
    const user = await User.findOne({ username });
    
    if (!user) {
      console.log(`User not found for username: ${username}`);
      notFound();
    }

    console.log(`Fetching repositories for user: ${user._id}`);
    const repositories = await Repository.find({ userId: user._id })
      .sort({ isFeatured: -1, stars: -1 });

    console.log(`Found ${repositories.length} repositories`);

    return (
      <ThemeProvider
        attribute="class"
        defaultTheme={user.theme?.id || 'light'}
        forcedTheme={user.theme?.id || 'light'}
      >
        <main className="min-h-screen bg-background">
          <PortfolioHeader user={user} />
          <div className="container px-4 py-8">
            <RepositoryGrid repositories={repositories} />
          </div>
        </main>
      </ThemeProvider>
    );
  } catch (error) {
    console.error('Error in PortfolioPage:', error);
    return <div>An error occurred while loading the portfolio. Please try again later.</div>;
  }
}
